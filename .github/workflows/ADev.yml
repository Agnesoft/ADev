name: ADev

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  check_code:
    name: Check Code
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Formatting
      run: |
        git fetch origin master
        COMMITTED_FILES=`git diff --name-only HEAD origin/master | grep 'cpp\|hpp'` || [[ $? == 1 ]]
        if [ ! -z "$COMMITTED_FILES" ]
        then
          sudo apt update
          sudo apt install software-properties-common
          sudo add-apt-repository "deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-10 main"
          sudo apt install clang-format-10
          clang-format-10 -i $COMMITED_FILES
          UNFORMATTED_FILES=`git ls-files -m | grep 'cpp\|hpp'` || [[ $? == 1 ]]
          if [ ! -z "$UNFORMATTED_FILES" ]
          then
            echo Incorrectly formatted files:
            echo $UNFORMATTED_FILES
            echo Run \'clang-format $UNFORMATTED_FILES\' and commit the result
            exit 1
          fi
        fi

